<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Governance & Citizen Grievance Platform</title>
    <style>
        /* Base Styling & Branding */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #e9ecef; color: #333; }
        .header { background-color: #004d99; color: white; padding: 10px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .govt-logo { width: 50px; height: 50px; margin-right: 15px; filter: drop-shadow(0 0 1px #fff); } 
        .header h2 { margin: 0; font-size: 1.5rem; font-weight: 300; }
        .container { max-width: 1000px; margin: 30px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); }
        
        /* Role Selection Dashboard Styling */
        #role-selection { display: flex; justify-content: space-around; align-items: stretch; padding: 50px 0; }
        .role-card { 
            flex-basis: 45%; 
            padding: 40px; 
            border-radius: 10px; 
            text-align: center; 
            cursor: pointer; 
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid #ced4da;
        }
        .role-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); 
        }
        .role-card h3 { font-size: 1.8rem; margin-top: 10px; }
        .role-card p { color: #6c757d; margin-bottom: 20px; }

        /* Themed Colors for Clarity */
        .citizen-card { background-color: #e6f7ff; border-color: #007bff; } 
        .official-card { background-color: #f7e6e6; border-color: #dc3545; } 
        .role-card .role-button {
            padding: 12px 30px; 
            font-weight: 700; 
            width: 80%;
            border-radius: 30px;
            background-color: #007bff; 
        }
        .official-card .role-button {
            background-color: #dc3545; 
        }

        /* Standard Form and Step Styling */
        .step-form { display: none; padding-top: 20px; }
        .step-form.active { display: block; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #ccc; }
        .progress-bar div { padding: 15px 10px; background-color: #f8f9fa; color: #6c757d; border-radius: 4px 4px 0 0; flex-grow: 1; text-align: center; margin: 0 2px; font-weight: 600; cursor: default; transition: background-color 0.3s; }
        .progress-bar div.active { background-color: #007bff; color: white; border-bottom: 3px solid #0056b3; }
        
        /* Input and Label Alignment FIX */
        label { 
            display: block; 
            margin-bottom: 5px; 
        }
        
        /* ALIGNMENT FIX FOR RADIO BUTTONS (Submission Preference) */
        input[type="radio"] { 
            width: auto; 
            margin-right: 5px; 
            vertical-align: middle; 
            margin-bottom: 0; 
        }

        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); outline: none; }
        button { background-color: #007bff; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; font-weight: 600; transition: background-color 0.3s, transform 0.1s; }
        button:hover { background-color: #0056b3; transform: translateY(-1px); }
        .mandatory-label::after { content: ' *'; color: red; margin-left: 2px;}
        .otp-input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        .otp-input-group input { flex-grow: 1; margin-bottom: 0;}

        /* Dashboard & Table Styling */
        .dashboard-section { margin-top: 30px; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        #complaint-history-table { width:100%; text-align:left; border-collapse: collapse; margin-top: 15px; }
        #complaint-history-table th { background-color: #f2f2f2; padding: 12px; border: 1px solid #ddd; }
        #complaint-history-table td { padding: 12px; border: 1px solid #ddd; }
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .status-resolved { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>

<header class="header">
    <div style="display: flex; align-items: center;">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Emblem_of_India.svg/100px-Emblem_of_India.svg.png" 
             alt="Government of India Emblem" 
             class="govt-logo">
        <h2>E-Governance & Citizen Grievance Platform</h2>
    </div>
</header>

<div class="container">
    <div id="role-selection">
        
        <div class="role-card citizen-card" onclick="showStep('citizen-verification')">
            <h3>üë§ Citizen Grievance Portal</h3>
            <p>File a new complaint, track its progress, and review resolutions submitted by the government department.</p>
            <button class="role-button">Proceed as Citizen</button>
        </div>

        <div class="role-card official-card" onclick="window.location.href='govt_login.html'">
            <h3>üèõÔ∏è Government Official Dashboard</h3>
            <p>Access the prioritized queue, manage assigned tickets, and upload mandatory resolution proof.</p>
            <button class="role-button">Access Official Login</button>
        </div>
    </div>

    <div id="progress-bar" style="display: none;" class="progress-bar">
        <div id="p-step-1" class="active">1. Verification</div>
        <div id="p-step-2">2. Complaint Details</div>
        <div id="p-step-3">3. Confirmation & Dashboard</div>
    </div>

    <form id="citizen-verification" class="step-form">
        <h3>Step 1: Identity & Contact Verification</h3>
        <label for="name" class="mandatory-label">Full Name:</label>
        <input type="text" id="name" required placeholder="Enter full legal name">

        <label for="public-id" class="mandatory-label">Public ID (Aadhar/Voter/PAN):</label>
        <div class="otp-input-group">
            <input type="text" id="public-id" placeholder="Enter ID Number (10-12 alphanumeric)" 
                   pattern="[0-9A-Z]{10,12}" 
                   maxlength="12"
                   title="Must be 10 to 12 alphanumeric characters."
                   required>
            <button type="button" onclick="verifyId()">Verify ID</button>
        </div>
        <p id="id-status" style="color:red; margin-top:-10px;">Awaiting Verification</p>

        <label for="phone" class="mandatory-label">Phone Number:</label>
        <div class="otp-input-group">
            <input type="tel" id="phone" placeholder="10 Digit Phone Number" 
                   pattern="[0-9]{10}" 
                   maxlength="10" 
                   title="Phone number must be exactly 10 digits (0-9)."
                   required>
            <button type="button" onclick="sendOtp('phone')">Send OTP</button>
        </div>
        <input type="text" id="phone-otp" placeholder="Enter Phone OTP" style="width: calc(100% - 130px); margin-left: auto;">
        
        <label for="email" class="mandatory-label">Email Address:</label>
        <div class="otp-input-group">
            <input type="email" id="email" placeholder="Email Address for updates" required>
            <button type="button" onclick="sendOtp('email')">Send OTP</button>
        </div>
        <input type="text" id="email-otp" placeholder="Enter Email OTP" style="width: calc(100% - 130px); margin-left: auto;">
        
        <button type="button" onclick="nextStep('citizen-verification', 'complaint-submission')">Proceed to Complaint Details</button>
    </form>

    <form id="complaint-submission" class="step-form">
        <h3>Step 2: Grievance Details</h3>

        <label for="location-coords" class="mandatory-label">Exact Location of Problem (Map Pin/Address):</label>
        <input type="text" id="location-coords" placeholder="Street Address or Coordinates" required>

        <label for="category" class="mandatory-label">Category (Select One):</label>
        <select id="category" required>
            <option value="">-- Select Category (21 options) --</option>
            <option value="Road Maintenance">1. Road Maintenance (Potholes, Signage)</option>
            <option value="Water Supply">2. Water Supply & Leakage</option>
            <option value="Sanitation">3. Sanitation & Garbage Disposal</option>
            <option value="Public Safety">4. Public Safety & Lighting</option>
            <option value="Illegal Construction">5. Illegal Construction/Encroachment</option>
            <option value="Public Transport">6. Public Transport Issues</option>
            <option value="Health Services">7. Health Services & Hospitals</option>
            <option value="Education Facilities">8. Education Facilities</option>
            <option value="Noise Pollution">9. Noise/Air Pollution</option>
            <option value="Electricity">10. Electricity & Power Outages</option>
            <option value="Drainage">11. Drainage/Sewerage Blockage</option>
            <option value="Parks">12. Park & Public Area Upkeep</option>
            <option value="Document Delays">13. Document & Certificate Delays</option>
            <option value="Official Misconduct">14. Official Misconduct/Bribery</option>
            <option value="Animal Control">15. Stray Animal Control</option>
            <option value="Tree Felling">16. Illegal Tree Felling</option>
            <option value="Traffic Signals">17. Traffic Signals & Management</option>
            <option value="Taxes">18. Property/Other Tax Issues</option>
            <option value="Social Welfare">19. Social Welfare Scheme Delays</option>
            <option value="Cyber">20. Cyber & IT Related Grievance</option>
            <option value="Other">21. Other/Miscellaneous</option>
        </select>

        <label for="description" class="mandatory-label">Detailed Description of Problem:</label>
        <textarea id="description" rows="5" required placeholder="Describe the issue, including severity (e.g., 'urgent', 'dangerous')"></textarea>

        <label for="media-upload" class="mandatory-label">Proof (Photo/Video):</label>
        <input type="file" id="media-upload" accept="image/*,video/*" required>

        <h4>Submission Preference</h4>
        <div style="display: flex; gap: 20px; align-items: baseline;">
            <label style="margin-bottom: 0; display: inline;">
                <input type="radio" name="submission-type" value="verified-id" checked> Submit with **Verified Public ID**
            </label>
            <label style="margin-bottom: 0; display: inline;">
                <input type="radio" name="submission-type" value="anonymous"> Submit **Anonymously**
            </label>
        </div>

        <button type="button" onclick="submitComplaint()">Submit Complaint</button>
    </form>

    <div id="citizen-dashboard" class="step-form">
        <h3 id="dashboard-greeting">Welcome back, Citizen.</h3>
        
        <div id="new-submission-confirmation" class="dashboard-section" style="background-color: #e6f7ff;">
            <h4>‚úÖ Latest Submission Successful!</h4>
            <p>Your unique Tracking ID is: <strong id="last-tracking-id">N/A</strong></p>
            <p>Current Status: <span class="status-pill status-pending">Under AI Review</span></p>
        </div>

        <div class="dashboard-section">
            <h4>Complaint History & Status Tracking</h4>
            <table id="complaint-history-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Priority (P)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="complaint-history-tbody">
                    </tbody>
            </table>
        </div>

        <button onclick="showStep('complaint-submission')" style="background-color: #28a745;">File New Complaint</button>
    </div>

</div>

<script>
    const steps = ['citizen-verification', 'complaint-submission', 'citizen-dashboard'];
    
    // --- LOCAL STORAGE UTILITY FUNCTIONS (Reverted to stable version) ---
    
    // Initial mock data array (used if localStorage is completely empty)
    const INITIAL_MOCK_DATA = [
        { id: 'GRV-551098', category: 'Water Supply', status: 'Resolved', priority: 7, department: 'Water_Supply_Dept', location: 'Sector 42', assigned_to: 'Officer_A_Water', citizen_name: 'Mock User', citizen_contact: '9988776655', citizen_email: 'mock@test.com' },
        { id: 'GRV-990011', category: 'Road Maintenance', status: 'Assigned', priority: 5, department: 'Public_Works_Dept', location: 'Main Road', assigned_to: 'Officer_C_Roads', citizen_name: 'Mock User 2', citizen_contact: '9900990099', citizen_email: 'mock2@test.com' }
    ];
    
    function getLocalComplaints() {
        const stored = localStorage.getItem('local_complaint_db');
        
        // If data is stored, parse and return it immediately.
        if (stored) {
            return JSON.parse(stored);
        }

        // Initialize and save the mock data only on the very first session
        saveLocalComplaints(INITIAL_MOCK_DATA);
        return INITIAL_MOCK_DATA;
    }
    
    function saveLocalComplaints(complaints) {
        localStorage.setItem('local_complaint_db', JSON.stringify(complaints));
    }
    
    let complaintDataStore = getLocalComplaints(); 

    // --- PAGE NAVIGATION LOGIC ---

    function showStep(stepId) {
        document.querySelectorAll('.step-form').forEach(form => form.classList.remove('active'));
        document.getElementById(stepId).classList.add('active');

        if (stepId !== 'role-selection') {
            document.getElementById('role-selection').style.display = 'none';
            document.getElementById('progress-bar').style.display = 'flex';
        }
        
        let index = steps.indexOf(stepId);
        document.querySelectorAll('.progress-bar div').forEach((div, i) => {
            div.classList.toggle('active', i <= index);
        });

        if (stepId === 'citizen-dashboard') {
             const userName = document.getElementById('name').value || "Citizen";
             document.getElementById('dashboard-greeting').innerHTML = `Welcome back, <strong>${userName}</strong>.`;
             // Refresh data from localStorage before showing the table
             complaintDataStore = getLocalComplaints(); 
             updateDashboardTable();
        }
    }

    function nextStep(currentId, nextId) {
        const currentForm = document.getElementById(currentId);
        if (!currentForm.checkValidity()) {
            currentForm.reportValidity();
            return;
        }
        if (currentId === 'citizen-verification') {
             if (document.getElementById('id-status').textContent !== 'ID Verified!') {
                alert('Please verify your Public ID and OTPs before proceeding.');
                return;
            }
        }
        
        showStep(nextId);
    }

    // --- Mock Verification Functions (unchanged) ---
    function sendOtp(field) { alert(`OTP sent to ${field}! (MOCK SUCCESS)`); }
    function verifyId() { 
        document.getElementById('id-status').textContent = 'Verifying ID...';
        setTimeout(() => {
            document.getElementById('id-status').textContent = 'ID Verified!';
            document.getElementById('id-status').style.color = 'green';
        }, 1500);
    }

    // --- SUBMISSION FUNCTION (Connects to Backend and Saves to LocalStorage) ---
    function submitComplaint() {
        const complaintData = {
            name: document.getElementById('name').value,
            public_id: document.getElementById('public-id').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value || "N/A",
            location_coords: document.getElementById('location-coords').value,
            category: document.getElementById('category').value,
            description: document.getElementById('description').value,
            is_anonymous: document.querySelector('input[name="submission-type"]:checked').value === 'anonymous'
        };

        const API_BASE_URL = 'http://127.0.0.1:5000'; // Default local Flask URL
        
        fetch(API_BASE_URL + '/api/submit_complaint', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(complaintData)
        })
        .then(response => {
            if (!response.ok) { 
                return response.json().then(err => { throw new Error(err.message || `HTTP error! status: ${response.status}`); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // 1. Construct the NEW complaint object from data received
                const newComplaint = {
                    id: data.tracking_id,
                    category: complaintData.category,
                    status: 'Under AI Review',
                    priority: data.priority,
                    assigned_to: data.assigned_to, 
                    location: complaintData.location_coords,
                    description: complaintData.description,
                    citizen_name: complaintData.name,
                    citizen_contact: complaintData.phone,
                    citizen_email: complaintData.email,
                    department: data.assigned_to.split('_Manager')[0] || data.assigned_to.split('_')[0],
                };
            
                // 2. GET current stored complaints, add the new one, and SAVE
                let allComplaints = getLocalComplaints();
                allComplaints.push(newComplaint);
                saveLocalComplaints(allComplaints); 
                
                // 3. Update the confirmation message and redirect
                document.getElementById('last-tracking-id').textContent = data.tracking_id;

                showStep('citizen-dashboard');
                document.getElementById('new-submission-confirmation').style.display = 'block'; 
            } else {
                alert("Submission failed: " + data.message);
            }
        })
        .catch(error => {
            console.error('Connection/Validation Error:', error.message);
            alert("Submission Failed: " + error.message);
        });
    }

    // --- DASHBOARD FUNCTIONS ---
    function updateDashboardTable() {
        const tbody = document.getElementById('complaint-history-tbody');
        tbody.innerHTML = ''; 

        // Load latest data from localStorage before displaying
        complaintDataStore = getLocalComplaints(); 
        const displayData = [...complaintDataStore].reverse(); 

        displayData.forEach(item => {
            const row = tbody.insertRow();
            const statusClass = item.status.toLowerCase().includes('resolved') ? 'status-resolved' : 'status-pending';
            
            row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.category}</td>
                <td><span class="status-pill ${statusClass}">${item.status}</span></td>
                <td>${item.priority}</td>
                <td>
                    <button onclick="trackQueue('${item.id}')">Track/Queue</button>
                    ${item.status.toLowerCase().includes('resolved') ? `<button onclick="reviewComplaint('${item.id}')" style="background-color:#ffc107; margin-left: 5px;">Review</button>` : ''}
                </td>
            `;
        });
    }

    function trackQueue(id) {
        const complaint = getLocalComplaints().find(c => c.id === id) || {priority: 'N/A', status: 'Unknown', assigned_to: 'N/A'};
        const mockQueuePosition = Math.floor(Math.random() * 15) + 1;
        alert(`Complaint ID: ${id}\nStatus: ${complaint.status}\nAssigned to: ${complaint.assigned_to}\nQueue Position: ${mockQueuePosition} (Priority P=${complaint.priority})`);
    }

    function reviewComplaint(id) {
        alert(`Reviewing Complaint ID: ${id}\nResolution Proof: [Photo/Video Link]\nFeedback: [5 Star Rating Form] and Re-Complaint Button.`);
    }

    showStep('role-selection');
</script>
</body>
</html>