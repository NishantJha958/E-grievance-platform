<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Official Grievance Management Dashboard</title>
    <style>
        /* Professional Government/Internal UI Styling */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: #333; margin: 0; padding: 0;}
        .header { background-color: #1a5276; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
        
        /* KPI Section */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-left: 5px solid #007bff; }
        .kpi-card h4 { margin-top: 0; color: #6c757d; font-weight: 400; }
        .kpi-card p { font-size: 2rem; font-weight: 700; margin: 0; }
        
        /* Filter and Triage Bar */
        .triage-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .triage-bar select { padding: 8px; border-radius: 4px; border: 1px solid #ced4da; }

        /* Table and Queue */
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .queue-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .queue-table th, .queue-table td { padding: 12px; border: 1px solid #dee2e6; text-align: left; font-size: 0.9rem; }
        .queue-table th { background-color: #e9ecef; font-weight: 600; color: #495057; }
        .priority-high { background-color: #f8d7da; color: #721c24; font-weight: 700; } /* Priority P>=8 */
        .priority-sla { background-color: #ffc107; color: #6a5200; font-weight: 700; } /* SLA nearing expiration */
        
        /* Action Buttons */
        .btn-resolve { background-color: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .btn-resolve:hover { background-color: #1e7e34; }
        .btn-detail, .btn-escalate { background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .btn-escalate { background-color: #6c757d; }

        /* Modal for Resolution */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border-radius: 8px; width: 80%; max-width: 800px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .modal-content input, .modal-content textarea, .modal-content select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .contact-info { background: #f0f0f0; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .proof-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd; }
    </style>
</head>
<body onload="loadOfficialDashboard()">

<div class="header">
    <h2>ðŸŽ¯ Grievance Resolution Dashboard</h2>
    <div style="font-size: 1rem;">
        Welcome, <span id="official-name">Loading...</span> | <span id="official-dept">Loading...</span>
    </div>
</div>

<div class="container">
    
    <h3>Team Performance Snapshot</h3>
    <div class="kpi-grid">
        <div class="kpi-card" style="border-left: 5px solid #dc3545;">
            <h4>Open High-Priority (P >= 8)</h4>
            <p id="kpi-high-priority">0</p>
        </div>
        <div class="kpi-card">
            <h4>Total Open Tickets</h4>
            <p id="kpi-total-tickets">0</p>
        </div>
        <div class="kpi-card" style="border-left: 5px solid #28a745;">
            <h4>Resolved Today</h4>
            <p id="kpi-resolved">0</p>
        </div>
        <div class="kpi-card" style="border-left: 5px solid #ffc107;">
            <h4>Avg. Resolution Time</h4>
            <p id="kpi-avg-time">--</p>
        </div>
    </div>
    
    <h3>Active Queue (Prioritized by AI Score)</h3>
    <div class="triage-bar">
        <div>
            <strong>Filter by:</strong>
            <select id="filter-status" onchange="loadOfficialDashboard()">
                <option value="ALL">All Active Tickets</option>
                <option value="SLA_RISK">SLA Risk (High P)</option>
                <option value="RESOLVED">Resolved (Awaiting Review)</option>
            </select>
        </div>
        <div id="sla-status">
            <span style="color: #dc3545;">SLA Monitor:</span> **0** high-risk tickets.
        </div>
    </div>


    <div class="table-container">
        <table class="queue-table">
            <thead>
                <tr>
                    <th>Tracking ID</th>
                    <th>**P Score**</th>
                    <th>Category</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>**SLA**</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="complaint-queue-tbody">
                </tbody>
        </table>
    </div>
</div>

<div id="resolutionModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeResolutionModal()">&times;</span>
        <h3>Resolution/Action for Ticket <span id="modal-tracking-id"></span></h3>
        
        <div class="contact-info">
            <h4>Complaint Context</h4>
            <p><strong>Citizen Contact:</strong> <span id="modal-citizen-phone"></span> | **Email:** <span id="modal-citizen-email"></span></p>
            <p><strong>Initial Complaint:</strong> <span id="modal-description"></span></p>
            <p><strong>Citizen Proof:</strong> <a href="#" id="modal-citizen-proof-link" target="_blank">View Uploaded File</a></p>
        </div>

        <hr>
        
        <div class="proof-section">
            <h4>Update Status & Finalize</h4>
            
            <label for="new-status">Update Ticket Status:</label>
            <select id="new-status">
                <option value="Under AI Review">Under AI Review</option>
                <option value="Assigned">Assigned (Initial Review)</option>
                <option value="Action Taken">Action Taken (Fieldwork Complete)</option>
                <option value="Resolved">Resolved (Final Closure)</option>
            </select>
            
            <label for="re-route-dept" style="margin-top: 15px;">Escalation/Re-route to:</label>
            <select id="re-route-dept">
                <option value="">-- No Re-route / Escalation --</option>
                <option value="Traffic_Police_Dept">Traffic Police Dept</option>
                <option value="Power_Dept">Power Dept (Electrical)</option>
                <option value="Public_Works_Dept">Public Works Dept</option>
                <option option value="General_Admin_Dept">General Admin Dept</option>
            </select>
            
            <label for="resolution-details" style="margin-top: 15px;">Resolution Summary:</label>
            <textarea id="resolution-details" rows="4" placeholder="Describe the action taken to resolve the grievance. (Mandatory for 'Resolved' status)" required></textarea>
            
            <label for="proof-upload">Upload Proof of Resolution (Mandatory for closure):</label>
            <input type="file" id="proof-upload" accept="image/*,video/*" required>
        </div>

        <button class="btn-resolve" style="width: 100%; margin-top: 20px;" onclick="finalizeResolution()">Finalize & Close Ticket / Update Status</button>
    </div>
</div>

<script>
    // --- LOCAL STORAGE MANAGEMENT FUNCTIONS ---

    function getLocalComplaints() {
        const stored = localStorage.getItem('local_complaint_db');
        // Initial mock data is loaded if nothing is in localStorage
        const initialMockData = [
            { id: 'GRV-551098', category: 'Water Supply', status: 'Under AI Review', priority: 7, department: 'Water_Supply_Dept', location: 'Sector 42', assigned_to: 'Officer_A_Water', citizen_name: 'Mock User', citizen_contact: '9988776655', citizen_email: 'mock@test.com' },
            { id: 'GRV-990011', category: 'Road Maintenance', status: 'Assigned', priority: 5, department: 'Public_Works_Dept', location: 'Main Road', assigned_to: 'Officer_C_Roads', citizen_name: 'Mock User 2', citizen_contact: '9900990099', citizen_email: 'mock2@test.com' }
        ];
        
        if (!stored) {
            saveLocalComplaints(initialMockData);
            return initialMockData;
        }
        return JSON.parse(stored);
    }

    function saveLocalComplaints(complaints) {
        localStorage.setItem('local_complaint_db', JSON.stringify(complaints));
    }

    function updateTicketStatusInStorage(ticketId, newStatus, newDepartment = null) {
        let allComplaints = getLocalComplaints();
        const index = allComplaints.findIndex(t => t.id === ticketId);

        if (index !== -1) {
            allComplaints[index].status = newStatus;
            if (newDepartment) {
                allComplaints[index].department = newDepartment;
                allComplaints[index].assigned_to = newDepartment + '_Manager'; 
            }
            // If ticket is resolved, update its status property completely
            if (newStatus === 'Resolved') {
                 allComplaints[index].status = 'Resolved';
                 // Optionally clear assignment
                 allComplaints[index].assigned_to = 'Closed'; 
            }
            
            saveLocalComplaints(allComplaints);
            return true;
        }
        return false;
    }

    // --- DASHBOARD LOGIC ---

    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    function loadOfficialDashboard() {
        // 1. Get Officer Details
        const officerName = getQueryParam('name') || 'Administrator';
        const officerDept = getQueryParam('dept') || 'Water_Supply_Dept'; 
        const filterValue = document.getElementById('filter-status').value;

        document.getElementById('official-name').textContent = officerName.replace(/\+/g, ' ');
        document.getElementById('official-dept').textContent = officerDept.replace(/_/g, ' ');
        
        // 2. Load all submitted tickets from localStorage (the live data)
        const rawComplaints = getLocalComplaints();
        
        // 3. Initial Filtering: Filter by the officer's department
        let filteredTickets = rawComplaints.filter(ticket => 
            ticket.department === officerDept || officerDept === 'General_Admin_Dept'
        );

        // 4. Apply Triage Filters (Status)
        if (filterValue === 'SLA_RISK') {
             // SLA RISK: Tickets P>=7 and NOT resolved
             filteredTickets = filteredTickets.filter(t => t.status !== 'Resolved' && t.priority >= 7); 
        } else if (filterValue === 'RESOLVED') {
             // Show only resolved tickets
             filteredTickets = filteredTickets.filter(t => t.status === 'Resolved');
        } else { // 'ALL' or Default
             // Show all non-resolved tickets
             filteredTickets = filteredTickets.filter(t => t.status !== 'Resolved');
        }


        // 5. Sort by Priority Score (P Score) descending
        filteredTickets.sort((a, b) => b.priority - a.priority); 

        // 6. Update KPIs
        const highPriorityCount = filteredTickets.filter(t => t.priority >= 8).length;
        const resolvedCount = rawComplaints.filter(t => t.status === 'Resolved').length;
        const slaRiskCount = rawComplaints.filter(t => t.status !== 'Resolved' && t.priority >= 7).length; // High P and Open
        
        document.getElementById('kpi-high-priority').textContent = highPriorityCount;
        document.getElementById('kpi-total-tickets').textContent = filteredTickets.length;
        document.getElementById('kpi-resolved').textContent = resolvedCount;
        document.getElementById('sla-status').innerHTML = `<span style="color: ${slaRiskCount > 0 ? '#dc3545' : '#28a745'};">SLA Monitor:</span> **${slaRiskCount}** high-risk tickets.`;


        // 7. Populate the Queue Table
        const tbody = document.getElementById('complaint-queue-tbody');
        tbody.innerHTML = '';

        if (filteredTickets.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #6c757d;">No active complaints assigned to ${officerDept.replace(/_/g, ' ')}.</td></tr>`;
        }

        filteredTickets.forEach(ticket => {
            const row = tbody.insertRow();
            let rowClass = ticket.priority >= 8 ? 'priority-high' : '';
            if (ticket.priority >= 7 && ticket.status !== 'Resolved') {
                 rowClass = 'priority-sla'; // Highlight high priority unresolved tickets
            }
            row.className = rowClass;

            row.innerHTML = `
                <td>${ticket.id}</td>
                <td>**${ticket.priority}**</td>
                <td>${ticket.category}</td>
                <td>${ticket.location}</td>
                <td>${ticket.status}</td> 
                <td>${rowClass === 'priority-sla' ? '<strong style="color:#dc3545;">RISK</strong>' : 'On Track'}</td>
                <td>
                    <button class="btn-resolve" onclick="openResolutionModal('${ticket.id}')">Action</button>
                </td>
            `;
        });
    }

    function fetchComplaintDetails(id) {
        // Fetch details from local storage
        let allComplaints = getLocalComplaints();
        return allComplaints.find(t => t.id === id);
    }

    function openResolutionModal(id) {
        const details = fetchComplaintDetails(id);
        if (!details) { alert("Ticket not found!"); return; }
        
        document.getElementById('modal-tracking-id').textContent = details.id;
        // Populate modal with dynamic data
        document.getElementById('modal-citizen-phone').textContent = details.citizen_contact;
        document.getElementById('modal-citizen-email').textContent = details.citizen_email;
        document.getElementById('modal-description').textContent = details.description;
        document.getElementById('modal-citizen-proof-link').href = 'mock_citizen_proof_file.pdf'; // Mock Proof Link
        
        // Reset and set current status
        document.getElementById('resolution-details').value = '';
        document.getElementById('re-route-dept').value = '';
        document.getElementById('new-status').value = details.status;
        
        document.getElementById('resolutionModal').style.display = 'block';
    }

    function closeResolutionModal() {
        document.getElementById('resolutionModal').style.display = 'none';
    }

    function finalizeResolution() {
        const resolutionText = document.getElementById('resolution-details').value;
        const proofFile = document.getElementById('proof-upload').files[0];
        const newStatus = document.getElementById('new-status').value;
        const reRouteDept = document.getElementById('re-route-dept').value;
        const ticketId = document.getElementById('modal-tracking-id').textContent;

        // 1. DUTY: ESCALATION/RE-ROUTE
        if (reRouteDept) {
            if (updateTicketStatusInStorage(ticketId, 'Rerouted', reRouteDept)) {
                alert(`[ACTION] Ticket ${ticketId} SUCCESSFULLY RE-ROUTED to ${reRouteDept}. New department assigned.`);
            }
            closeResolutionModal();
            window.location.reload(); 
            return;
        }

        // 2. DUTY: RESOLUTION CLOSURE CHECK
        if (newStatus === 'Resolved' && (!resolutionText || !proofFile)) {
            alert("ERROR: Resolution Summary and Proof Upload are mandatory to mark status as 'Resolved'.");
            return;
        }

        // 3. DUTY: UPDATE STATUS IN LOCAL STORAGE
        if (updateTicketStatusInStorage(ticketId, newStatus)) {
            alert(`[SUCCESS] Ticket ${ticketId} status updated to ${newStatus}.`);
        } else {
            alert("ERROR: Could not find ticket in storage.");
        }
        
        // If status is resolved, trigger CLOSURE & FEEDBACK
        if (newStatus === 'Resolved') {
            alert("CLOSURE COMPLETE: Citizen notified for final satisfaction feedback.");
        }
        
        closeResolutionModal();
        window.location.reload(); 
    }
</script>

</body>
</html>